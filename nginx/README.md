# Конфигурация Nginx

## Терминология

*Дериктива (Directive)* - заданная опция конфигурации. Состоит из имени и значения.
```nginx
server_name mydomain.com
```

*Контенкст (Context)* - область конфигурации. Директивы, заданные в ней, влияют на эту область. Они могут вкладываться друг в друга и наследовать значения от родителя. Самый главный контекст - сам кофигурационный файл и называется *Главный контекст (Main Context)*.
```nginx
http {
    # директивы, влияющие на http и server
    # ...

    server {
        # директивы, влияющие на server
        # ...
    }
}
```
## Создание виртуального хоста

*Виртуальный хост* может раздавать статические файлы. Допустим у нас есть html-страницы по пути `/sites/demo`. В нём будут находиться 3 файла:
```
index.html
style.css
thumb.png
```

Главный конфигурационный файл находится здесь: `/etc/nginx/nginx.conf`. Начнём строить его с нуля:
```nginx
events {} # контекст events удалять полностью нельзя, иначе файл будет невалидным

http {
    # ...
}
```

Каждый виртуальный хост означает новый контекст **server**. Виртуальный хост будет слушать порт **80** для http и **443** для https.
```nginx
events{}

http {
    server {
        listen 80; # всё директивы заканчиваются точкой с запятой

        server_name 16.231.154.7; 

        root /sites/demo;
    }
}
```
`listen порт` - какой порт слушать. Если не указывать порт, то nginx будет автоматически слушать порт 80. Но хорошей практикой считается указывать его очивидно. 

`server_name домен` - домен, субдомен или ip-адрес, для которого будет работать текущий контекст. В домене можно указывать звёздочку (__*__), которая означает _любое значение_. Например, `*.domain.com` будет совпадать с любым субдоменом.

`root путь` - путь, из которого nginx будет отдавать файлы при запросе. Если придёт запрос `/images/cat.png`, то nginx будет искать его в `[root]/images/cat.png`. В нашем случае `/sites/demo/images/cat.png`.

## Перезапуск nginx с помощью systemd

Проверить конфиг и, если он валидный, остановить сервер и запустить его заново:
```
systemctl reload nginx
```

Остановить сервер, потом проверить конфиг и, если он валидный, запустить сервер. Если конфиг окажется невалидный, то остановленный сервер откажется запускаться.
```
systemctl restart nginx
``` 

Проверить конфиг вручную:
```
nginx -t
```

## Mimetypes и `include`

Если запустим сервер, то увидим наш сайт. Но заметим, что стили не работают. Когда nginx отправлял файл style.css клиенту, то указал неверный Content-Type.

Проверить Content-Type:
```
curl -I http://ip-адрес/style.css

# Ответ:
# ...
Content-Type: text/plain
# ...
```

Для того, чтобы это исправить, мы должны сообщить nginx правильные mimetype для разных расширений файлов с помощью контекста `types {}`.
```nginx
# nginx.conf

http {
    types {
        text/html html;
        text/css css;

        server {
            # ...
        }
    }   
}
```

Но указывать вручную все эти типы необязательно, т.к. у nginx уже есть файл `mime.types`, содержащий много частоиспользуемых типов. 

Всё, что нам нужно, это подключить в конфиг с помощью директивы `include`:
```nginx
# nginx.conf

http {
    types {
        include mime.types;

        server {
            # ...
        }
    }   
}
```

## Блоки локаций

Контексты `location {}` позволяют обрабатывать определённые пути по-особенному.
```nginx
server {
    location URI {
        # ...
    }
}
```

Например, будем возвращать строку клиенту, который будет переходить по адресу `/grret`:
```nginx
events{}

http {
    server {
        listen 80;
        server_name 16.231.154.7; 
        root /sites/demo;

        location /greet {
            return 200 "Hello from NGINX '/greet' location!";
        }
    }
}
```

`location URI` называется *совпадением префикса* (Prefix match). То есть, он сработает на все URI, которые начинаются с указанной строки. Например, `location /greet` также поймает `/greeting` и даже `/greeting/more`.

Если нужно точное совпадение (Exact match), то можно добавить знак равно:
```nginx
location = /greet {
    # ...
}
```

Совпадение по регулярному выражению возможно с помощью тильды (__~__):
```nginx
# Совпадение с greet0, greet1 и т.д. (регистрозависимо)
location ~ /greet[0-9] {
    # ...
}

# Чтобы было регистроНЕзависимо, то используется тильда со звёздочкой (~*)
location ~* /greet[0-9] {
    # ...
}
```

Приоритет: Regex -> Exact -> Prefix.